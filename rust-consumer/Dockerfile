# Use the official Rust image as a base for building
FROM rust:1.77.1 as build

# Create a new empty shell project
RUN USER=root cargo new --bin workers
WORKDIR /workers

# Copy over your manifests
COPY ./Cargo.lock ./Cargo.lock
COPY ./Cargo.toml ./Cargo.toml

# Build step to cache dependencies
RUN cargo build --release

# Remove the default main.rs generated by `cargo new`
COPY . .

# Build for release
RUN cargo build --release

# Our final base image
FROM rust:1.77.1

# Copy the built binary from the build stage
COPY --from=build /workers/target/release/workers /bin/server

# Define the command to run the server
CMD ["/bin/server"]
